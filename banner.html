<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>WeaD Banner Archive v234</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary-orange: #f3946a; --text-black: #111; --text-gray: #999; --border-light: #eee; }
        * { box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
        body { margin: 0; background: #fff; color: var(--text-black); overflow-x: hidden; }

        header { 
            width: 100%; height: 70px; background: #fff; border-bottom: 1px solid var(--border-light);
            display: flex; justify-content: center; position: sticky; top: 0; z-index: 1000;
        }
        .header-inner { width: 100%; max-width: 1400px; display: flex; align-items: center; justify-content: flex-start; }
        .logo { display: flex; align-items: center; font-size: 20px; font-weight: 900; color: #000; text-decoration: none; }
        .logo-icon { width: 22px; height: 22px; background: linear-gradient(135deg, #f3946a, #8e44ad); border-radius: 5px; margin-right: 10px; }
        
        nav { display: flex; gap: 40px; margin-left: 60px; height: 70px; }
        nav a { text-decoration: none; color: var(--text-gray); font-size: 16px; font-weight: 700; display: flex; align-items: center; position: relative; height: 100%; }
        nav a.active { color: var(--text-black); }
        nav a.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px; background-color: var(--text-black); }

        .search-area { display: flex; justify-content: flex-end; margin-bottom: 20px; }
        .search-container { position: relative; width: 320px; }
        .search-container input { width: 100%; padding: 12px 18px; padding-right: 45px; border: 1px solid #ddd; border-radius: 8px; background: #fdfdfd; font-size: 14px; outline: none; }
        .search-container i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }

        .wrapper { display: flex; max-width: 1400px; margin: 0 auto; min-height: calc(100vh - 70px); }
        .sidebar { width: 151px; padding: 50px 0; flex-shrink: 0; margin-right: 48px; }
        .side-item { padding: 12px 20px; font-size: 14px; font-weight: 700; color: #666; cursor: pointer; border-radius: 8px; margin-bottom: 5px; }
        .side-item.active { background: #f3f3f3; color: var(--text-black); }

        .main-content { flex-grow: 1; padding: 60px 0; }
        .main-title { font-size: 42px; font-weight: 900; margin-bottom: 10px; letter-spacing: -1px; }

        .brand-filters { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; }
        .brand-btn { padding: 8px 20px; border-radius: 20px; background: #f1f3f7; font-size: 13px; font-weight: 600; color: #888; cursor: pointer; border: none; transition: 0.2s; }
        .brand-btn.active { background: var(--primary-orange) !important; color: #fff !important; }

        .banner-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; }
        .banner-grid.grid-5 { grid-template-columns: repeat(5, 1fr); gap: 15px; }
        .banner-item { border-radius: 12px; transition: 0.3s; cursor: pointer; position: relative; overflow: hidden; border: 1px solid var(--border-light); }
        .banner-item:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .img-box { width: 100%; border-radius: 12px; overflow: hidden; background: #f4f4f4; display: flex; align-items: center; justify-content: center; }
        .img-box img { width: 100%; height: auto; display: block; }
        
        .count-info { font-size: 14px; font-weight: 700; margin-bottom: 20px; color: #444; }
        .count-info b { color: var(--primary-orange); }
        .pagination { display: flex; justify-content: center; margin-top: 50px; gap: 8px; }
        .page-dot { width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid #eee; background: #fff; cursor: pointer; font-weight: 700; color: #999; }
        .page-dot.active { background: var(--primary-orange); color: #fff; border-color: var(--primary-orange); }
    </style>
</head>
<body>

<header>
    <div class="header-inner">
        <a href="#" class="logo"><div class="logo-icon"></div>We<span>aD</span></a>
        <nav>
            <a href="landing.html">랜딩</a>
            <a href="banner.html" class="active">배너</a>
        </nav>
    </div>
</header>

<div class="wrapper">
    <div class="sidebar">
        <div class="main-title" style="margin-top:50px;">Banner</div>
        <div class="side-item active" onclick="changeCategory('타임보드', this)">타임보드</div>
        <div class="side-item" onclick="changeCategory('페이스북', this)">페이스북</div>
    </div>
    <div class="main-content">
        <div class="search-area">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="키워드를 입력해주세요." oninput="realTimeSearch()">
                <i class="fas fa-search"></i>
            </div>
        </div>

        <div class="brand-filters" id="brandPills"></div>
        <div class="count-info" id="totalCnt">총 <b>0개</b>의 배너 (전체)</div>
        <div id="bannerGrid" class="banner-grid"></div>
        <div id="pagination" class="pagination"></div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://pfuwdbgnxkxcchjlwauc.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_GTnHAd2Q2wtlLjynoct2UA_r5RDvSPU';
    const BUCKET = 'banner';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const brandMap = { "더위크": "theweek", "더위크영어": "theweek_english", "더위크일본어": "theweek_japanese", "더위크스페인어": "theweek_spanish", "더위크중국어": "theweek_chinese", "결합상품": "bundle", "비아지오": "viaggio", "노르드킨": "nordkin", "기타": "others" };
    const categoryMap = { "타임보드": "timeboard", "페이스북": "facebook" };
    let currentCategory = '타임보드', currentBrand = '전체', currentPage = 1, itemsPerPage = 30, rollIntervals = {};
    let searchTimer;

    function realTimeSearch() { clearTimeout(searchTimer); searchTimer = setTimeout(() => { currentPage = 1; search(); }, 300); }

    function getSingleUrl(brand, category, frameName, nodeId) {
        const brandEng = brandMap[brand.replace(/\s/g, "").normalize('NFC')] || "others";
        const categoryEng = categoryMap[category] || "others";
        const idSuffix = nodeId.replace(':', '_');
        if (categoryEng === 'facebook') {
            const fbMatch = String(frameName).match(/(\d+)_(\d+x\d+)/);
            const fileName = fbMatch ? `fb_${fbMatch[2]}_${fbMatch[1]}_${idSuffix}` : `fb_${String(frameName).replace(/\s/g, '_')}_${idSuffix}`;
            return `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${brandEng}/${categoryEng}/${fileName}.jpg`;
        } else {
            const prefix = (String(frameName).match(/^[a-zA-Z0-9]+/) || ["banner"])[0];
            return `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${brandEng}/${categoryEng}/${prefix}_rolling1.jpg`;
        }
    }

    async function loadFeaturedBanners() {
        const { data } = await supabaseClient.from('banner').select('*').eq('is_main', true);
        const container = document.getElementById('mainBannersDisplay');
        if(!data || data.length === 0) { container.innerHTML = '<div style="color:#ccc; font-size:12px;">현재 진행 중인 메인 배너가 없습니다.</div>'; return; }
        container.innerHTML = data.map(item => `<div class="featured-item" onclick="window.open('https://www.figma.com/design/${item.file_key}/?node-id=${item.id.replace(':','-')}')"><div class="featured-brand-badge">${item.brand}</div><div class="img-box"><img src="${getSingleUrl(item.brand, item.category, item.name, item.id)}" onerror="this.src='https://placehold.co/600x300?text=No+Image';"></div></div>`).join('');
    }

    async function search() {
        const grid = document.getElementById('bannerGrid');
        const keyword = document.getElementById('searchInput').value;

        let query = supabaseClient.from('banner').select('*').eq('category', currentCategory.trim());
        if (currentBrand !== '전체') query = query.eq('brand', currentBrand.trim());
        
        // [v235 수정] content_txt 검색 기능 활성화
        if (keyword) query = query.or(`name.ilike.%${keyword}%,description.ilike.%${keyword}%,content_txt.ilike.%${keyword}%`);

        const { data: allData } = await query.order('id', { ascending: false });
        if (!allData || allData.length === 0) { document.getElementById('totalCnt').innerHTML = `총 <b>0개</b>`; grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:50px;">데이터가 없습니다.</div>'; return; }

        const seenPrefix = new Set();
        const uniqueBanners = allData.filter(item => {
            const nameStr = String(item.name || "");
            const catClean = currentCategory.trim();

            // [v235 수정] 페이스북 정사각형 필터링 정밀 강화
            if (catClean.includes('페이스북')) {
                const resMatch = nameStr.match(/(\d+)[\s]*[xX][\s]*(\d+)/);
                if (resMatch) {
                    // 가로와 세로 숫자가 똑같을 때만 노출 (610x1080 등은 제외)
                    return parseInt(resMatch[1]) === parseInt(resMatch[2]);
                }
                return false; 
            }

            if (nameStr.includes('rolling2') || nameStr.includes('rolling3')) return false;
            const prefix = (nameStr.match(/^[a-zA-Z0-9]+/) || [""])[0];
            if (prefix && seenPrefix.has(prefix)) return false;
            seenPrefix.add(prefix);
            return true;
        });

        document.getElementById('totalCnt').innerHTML = `총 <b>${uniqueBanners.length}개</b>의 배너`;
        const startIndex = (currentPage - 1) * itemsPerPage;
        const pageBanners = uniqueBanners.slice(startIndex, startIndex + itemsPerPage);

        grid.innerHTML = pageBanners.map(item => {
            const thumbUrl = getSingleUrl(item.brand, item.category, item.name, item.id);
            const rollingUrls = (currentCategory.includes('페이스북')) ? [thumbUrl] : [1, 2, 3].map(n => {
                const prefix = (String(item.name).match(/^[a-zA-Z0-9]+/) || ["banner"])[0];
                return `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${brandMap[item.brand.replace(/\s/g, "").normalize('NFC')] || 'others'}/timeboard/${prefix}_rolling${n}.jpg`;
            });
            return `<div class="banner-item" data-id="${item.id}" onmouseenter='startRolling(this, ${JSON.stringify(rollingUrls)})' onmouseleave='stopRolling(this, "${rollingUrls[0]}")' onclick="window.open('https://www.figma.com/design/${item.file_key}/?node-id=${item.id.replace(':','-')}')"><div class="img-box"><img src="${rollingUrls[0]}" onerror="this.src='https://placehold.co/600x300?text=No+Image';"></div></div>`;
        }).join('');
        renderPagination(uniqueBanners.length);
    }

    function startRolling(el, urls) { if (urls.length <= 1) return; let i = 0; const img = el.querySelector('img'); clearInterval(rollIntervals[el.dataset.id]); rollIntervals[el.dataset.id] = setInterval(() => { i = (i + 1) % urls.length; img.src = urls[i]; }, 800); }
    function stopRolling(el, firstUrl) { clearInterval(rollIntervals[el.dataset.id]); el.querySelector('img').src = firstUrl; }
    function changeCategory(cat, el) { document.querySelectorAll('.side-item').forEach(i => i.classList.remove('active')); el.classList.add('active'); currentCategory = cat; currentBrand = '전체'; currentPage = 1; document.getElementById('bannerGrid').className = (cat.includes('페이스북')) ? 'banner-grid grid-5' : 'banner-grid'; itemsPerPage = (cat.includes('페이스북')) ? 30 : 30; search(); loadBrands(); }
    async function loadBrands() { const { data } = await supabaseClient.from('banner').select('brand').eq('category', currentCategory.trim()); const brands = ['전체', ...new Set(data?.map(d => d.brand.normalize('NFC')) || [])]; document.getElementById('brandPills').innerHTML = brands.map(b => `<button class="brand-btn ${currentBrand === b ? 'active' : ''}" onclick="currentBrand='${b}'; currentPage=1; search(); loadBrands();">${b}</button>`).join(''); }
    function renderPagination(total) { const totalPages = Math.ceil(total / itemsPerPage); if(total <= itemsPerPage) { document.getElementById('pagination').innerHTML = ''; return; } let html = ''; for (let i = 1; i <= totalPages; i++) html += `<div class="page-dot ${i === currentPage ? 'active' : ''}" onclick="currentPage=${i}; search(); window.scrollTo(0,0);">${i}</div>`; document.getElementById('pagination').innerHTML = html; }

    changeCategory('타임보드', document.querySelector('.side-item.active'));
</script>
</body>
</html>
